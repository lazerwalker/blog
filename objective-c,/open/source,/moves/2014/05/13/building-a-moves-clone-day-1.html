<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>
    Building An Open-Source Moves Clone: Day 1
  </title>
  <meta name="description" content="Emilia is a Toronto-based game designer, conceptual artist, and software engineer.
" />

  <link
    href="/atom.xml"
    rel="alternate"
    title="Em Lazer-Walker"
    type="application/atom+xml"
  />

  <link rel="stylesheet" href="/css/main.css">
  <link
    rel="canonical"
    href="http://blog.lazerwalker.com/objective-c,/open/source,/moves/2014/05/13/building-a-moves-clone-day-1.html"
  />
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-STKNZZJ7SW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-STKNZZJ7SW');
  </script>

  /opengraph/314a4577d148ae597ff98239f7bfbe3da1ab691bb848ba93b1b961ac6701bee4.png
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Emilia Lazer-Walker</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Building An Open-Source Moves Clone: Day 1</h1>
    <p class="post-meta">May 13, 2014</p>
  </header>

  <article class="post-content">
    <p>One of my favorite iPhone apps is (or rather, was) <a href="http://moves-app.com">Moves</a>. Being able to see a daily breakdown of everywhere I’d been and all the walking and biking I did was incredibly useful for a whole bunch of reasons.</p>

<p>I recently uninstalled it from my phone. I always had vague concerns about sending that much data about my personal life to a third-party; the Facebook acquisition and subsequent changes to their privacy policy and terms of service were enough to get me to delete my account.</p>

<p>This week is reunion week at <a href="http://hackerschool.com">Hacker School</a>, so I have some time to hack on an open-source project. I’ve decided to take on a rather ambitious goal: build a complete functioning Moves clone for iOS. The idea is a tool that lets users truly own their data; the app will not send any of your data to a third-party server unless you explicitly export it, and since it will be open-source there’s no worry of that ever changing.</p>

<p>In this initial stage, I’m defining “success” to mean having an iPhone app I can use to aggregate GPS and motion data in such a way that I can both get a useful visualization on my phone (a la Moves) and analyze the data myself with a JSON-based data export (much like the export provided by <a href="http://www.reporter-app.com">Reporter</a>). I have a lot of bigger-picture ideas if the project is successful, but let’s take this one step at a time.</p>

<p>I’m not going to actually release the full source until it’s ready (it’ll eventually be on GitHub, license TBD), but I will hopefully be posting regular updates here with lots of code examples. Documenting the whole process, from dirty prototypes to finished app, will hopefully be a useful exercise for others.</p>

<h1 id="day-1-playing-with-data">Day 1: Playing With Data</h1>
<p>Moves presumably features a lot of complex signal processing code that reads in raw accelerometer data to help figure out if you are walking, biking, or riding in an automotive.</p>

<p>The M7 motion coprocessor in the iPhone 5S does a lot of that work for you: Apple’s CoreMotion API exposes a high-level API that expresses something resembling that. Because my time is so constrained, my first order of business was to take a look at what sort of data CoreMotion and CoreLocation were returning me to see if it was accurate enough to use.</p>

<p>As Sandi Metz says, “you’ll never know less than you do right now”. My goal for the day was to write a lot of shitty throwaway code to experiment with what data I could get from Apple.</p>

<h2 id="persisting-data">Persisting Data</h2>
<p>Before receiving data from CoreLocation and CoreMotion, having a way to save data to disk seemed important. While I suspect the app will ultimately need the power of CoreData, it was definitely overkill for the requirements of a prototype, which are roughly “let me shove some data onto the disk and then retrieve it later”.</p>

<p>I created a very simple model class to contain both location and activity data, poorly naming it <code class="language-plaintext highlighter-rouge">LocationList</code>. I choose to use <a href="https://github.com/Mantle/Mantle">Mantle</a> for now, purely to avoid needing to write NSCoding boilerplate.</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">	<span class="k">@interface</span> <span class="nc">LocationList</span> <span class="p">:</span> <span class="nc">MTLModel</span>

	<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">locations</span><span class="p">;</span>
	<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">activities</span><span class="p">;</span>

	<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">loadFromDisk</span><span class="p">;</span>

	<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLocations</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span><span class="p">;</span>
	<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addActivities</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">activities</span><span class="p">;</span>

	<span class="k">@end</span></code></pre></figure>

<p>This initial implementation is incredibly dumb. Calling <code class="language-plaintext highlighter-rouge">addLocations:</code> or <code class="language-plaintext highlighter-rouge">addActivites:</code> causes the appropriate internal array to be appended with new data, and then the object itself persisted to disk.</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">	<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLocations</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">locations</span><span class="p">)</span> <span class="n">self</span><span class="p">.</span><span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSArray</span> <span class="nf">new</span><span class="p">];</span>
	    <span class="n">self</span><span class="p">.</span><span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locations</span> <span class="nf">arrayByAddingObjectsFromArray</span><span class="p">:</span><span class="n">locations</span><span class="p">];</span>
	    <span class="p">[</span><span class="n">NSKeyedArchiver</span> <span class="nf">archiveRootObject</span><span class="p">:</span><span class="n">self</span> <span class="nf">toFile</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">.</span><span class="n">filepath</span><span class="p">];</span>
	<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">fetchFromDisk</code> merely retrieves that object again, or a new object if there isn’t one on-disk.</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">	<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">loadFromDisk</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="p">[</span><span class="n">NSKeyedUnarchiver</span> <span class="nf">unarchiveObjectWithFile</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">filepath</span><span class="p">]</span> <span class="p">?:</span> <span class="p">[</span><span class="n">self</span> <span class="nf">new</span><span class="p">];</span>
	<span class="p">}</span></code></pre></figure>

<p>(The class method <code class="language-plaintext highlighter-rouge">filepath</code> simply returns a handle to a filename based on the object’s class.)</p>

<p>To be clear: this is an absolutely terrible way of doing things. Even ignoring the eventual issues of memory requirements and complex querying with as large a dataset as I expect this app to have, there will almost certainly be nasty concurrency issues.</p>

<p>My goal wasn’t to write high-quality code that would last. My goal was to write the absolute dumbest thing possible that would let me see what the data I had coming in looked like. For now, this model provides a simple way to shove a small amount of data into a datastore and pull it out to display on-screen.</p>

<h2 id="processing-gps-data">Processing GPS Data</h2>
<p>Fetching location data, even in the background, is easy. After setting up a test app with  the background location key set in the plist, I created a new class to help manage a CLLocationManager. It didn’t do a lot.</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">	<span class="n">self</span><span class="p">.</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLLocationManager</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">manager</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">manager</span> <span class="nf">startUpdatingLocation</span><span class="p">];</span></code></pre></figure>

<p>From there, the <code class="language-plaintext highlighter-rouge">CLLocationManager</code> will simply call its delegate method over and over again, even when the app isn’t running, with updated data. Given our persistence layer, all we need to do is keep pushing those new updates onto our list.</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">	<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager</span><span class="p">:(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didUpdateLocations</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span> <span class="p">{</span>
	    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
	        <span class="n">LocationList</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">LocationList</span> <span class="nf">loadFromDisk</span><span class="p">];</span>
	        <span class="p">[</span><span class="n">list</span> <span class="nf">addLocations</span><span class="p">:</span><span class="n">locations</span><span class="p">];</span>
	    <span class="p">});</span>
	<span class="p">}</span></code></pre></figure>

<p>To be clear, this is just as inefficient and dumb as our persistence layer. Specifically, this will eat up battery like there’s no tomorrow, and probably return a lot more data than is needed. While there’s a lot of low-hanging fruit to make this more efficient, I didn’t care. I can optimize for battery life once things are working; I wanted to see the full range of accuracy the GPS is capable of, and make that happen as quickly as possible.</p>

<p>The process for receiving and fetching motion events was essentially the same, except for not being able to get backgroud updates. Instead, when the app loads, I needed to query the device for any motion activity that took place while it was closed. That’s easy to do by asking for everything since the last event stored on disk.</p>

<h2 id="generating-test-data">Generating Test Data</h2>
<p>Using the iOS simulator, it’s easy to falsify CoreLocation data. The simulator has a handful of pre-programmed routes you can select to simulate movement. However, that doesn’t exist for the M7. I ended up going for a brief walk and bike ride around the block to generate some data. Who says programming is a sedentary activity?</p>

<h2 id="visualization">Visualization</h2>
<p>The app’s sole view controller only has one view, a full-screen <code class="language-plaintext highlighter-rouge">MKMapView</code>. For the sake of visualizing the test data, I just used built-in <code class="language-plaintext highlighter-rouge">MKAnnotation</code> and <code class="language-plaintext highlighter-rouge">MKPolyline</code> objects.</p>

<p>The actual logic is a bit clunkier and longer than I’d like to show here, but it wasn’t particularly complex.</p>

<ul>
  <li>
    <p>The location and activity arrays were first joined and sorted by timestamp, resulting in  a complete chronological listing of all events.</p>
  </li>
  <li>
    <p>All location events following a “stationary” motion event were considered to be places I stopped.</p>
  </li>
  <li>
    <p>All location updates that took place between those stops were considered to be movement, respecting the movement types returned by CoreMotion (walking, running, automotive, unknown). These polylines were then rendered with different colors based on what activity type they were.</p>
  </li>
  <li>
    <p>For the sake of argument, I arbitrarily said that all “unknown” movement with an average speed of above 1.2 meters per second (determined by averaging the <code class="language-plaintext highlighter-rouge">speed</code> property of each <code class="language-plaintext highlighter-rouge">CLLocation</code> object in the path) was bike movement.</p>
  </li>
</ul>

<p>Here’s the result:</p>

<p><img src="/images/day1.png" alt="image" /></p>

<p>The data was fairly accurate. Basic data sanitization aside (smoothing out the lines, removing duplicate stops that are clearly the same location), there were two chief inaccuracies:</p>

<ul>
  <li>The green line (representing biking) should be a closed loop, so some biking was misinterpreted as walking (red) and running (blue).</li>
  <li>The higher of the two stops in the bottom-left corner should not have been interpreted as a stop; it was a five-second pause while maneuvering between cars in traffic.</li>
</ul>

<p>The largest problem is clearly going to be figuring out how to determine bicycle data, since the M7 doesn’t return that directly, but I’m fairly confident I’ll be able to find some sensible heuristics to improve that without needing to drop down to the level of processing raw accelerometer data. Even Moves doesn’t process bicycle data perfectly; I often found myself having to correct “walking” or “transit” paths into biking ones.</p>

<p>All in all, I think that’s pretty impressive for a first day of work. Above all, I proved my hypothesis: while the data isn’t perfect, it’s clear that the combination of GPS and M7 data should be more than sufficient to roughly approximate the work Moves was doing.</p>

<p>–</p>

<h1 id="update-from-the-future">Update From The Future</h1>

<p>Hello! If you’re reading this, you may be wondering what happened to this project.</p>

<p>Check out <a href="https://github.com/lazerwalker/Theseus">https://github.com/lazerwalker/Theseus</a>. It (sort of) works, but is neither in great shape code-wise nor actively maintained. There’s some more info in the README.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Emilia Lazer-Walker</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Emilia Lazer-Walker</li>
          <li><a href="mailto:blog@lazerwalker.com">blog@lazerwalker.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/lazerwalker">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">lazerwalker</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/lazerwalker">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">lazerwalker</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Emilia is a Toronto-based game designer, conceptual artist, and software engineer.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
